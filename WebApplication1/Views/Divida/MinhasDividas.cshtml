@using System.Text.Json
@model List<WebApplication1.Models.Divida>

@{
    ViewData["Title"] = "Minhas Dívidas";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@if (TempData["Mensagem"] != null)
{
    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
        @TempData["Mensagem"]
    </div>
}

<div class="container mx-auto py-8">
    <h2 class="text-3xl font-bold mb-6">Minhas Dívidas</h2>

    <table class="min-w-full bg-white rounded shadow-md overflow-hidden">
        <thead>
            <tr class="bg-gray-200 text-left text-gray-700 text-sm uppercase">
                <th class="px-4 py-2">Título</th>
                <th class="px-4 py-2">Descrição</th>
                <th class="px-4 py-2">Empresa</th>
                <th class="px-4 py-2">Vencimento</th>
                <th class="px-4 py-2">Pagamento</th>
                <th class="px-4 py-2">Status</th>
                <th class="px-4 py-2">Ações</th>
            </tr>
        </thead>
        <tbody id="dividasBody">
            @foreach (var item in Model)
            {
                var statusColor = item.Status switch
                {
                    "Pago" => "bg-green-100 text-green-800",
                    "Atrasado" => "bg-red-100 text-red-800",
                    _ => "bg-yellow-100 text-yellow-800"
                };
                <tr class="border-t main-row" data-id="@item.Id">
                    <td class="px-4 py-2">@item.Titulo</td>
                    <td class="px-4 py-2">@item.Descricao</td>
                    <td class="px-4 py-2">@item.Empresa.Nome</td>
                    <td class="px-4 py-2">@item.DataVencimento?.ToString("dd/MM/yyyy")</td>
                    <td class="px-4 py-2">@item.DataPagamento?.ToString("dd/MM/yyyy")</td>
                    <td class="px-4 py-2">
                        <span class="px-2 py-1 rounded-full text-xs font-semibold @statusColor">@item.Status</span>
                    </td>
                    <td class="px-4 py-2 space-x-2">
                        <button type="button" onclick="toggleDetails(@item.Id)"
                            class="bg-blue-500 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                            Detalhes
                        </button>
                    </td>
                </tr>
                <tr class="details-row hidden" id="details-@item.Id">
                    <td colspan="7" class="bg-gray-50 px-4 py-2 text-sm text-gray-700"></td>
                </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts {
    <script>
        const dividas = JSON.parse('@Html.Raw(ViewBag.DividasJson)');

        function toggleDetails(id) {
            const detailsRow = document.getElementById(`details-${id}`);
            const isHidden = detailsRow.classList.contains('hidden');

            // Oculta todos os detalhes
            document.querySelectorAll('[id^="details-"]').forEach(row => row.classList.add('hidden'));

            if (isHidden) {
                const divida = dividas.find(x => x.Id === id);
                if (!divida) return;

                const statusMensagem = divida.Status === "Pago"
                    ? "Esta dívida já foi paga."
                    : divida.Status === "Atrasado"
                        ? "Esta dívida está em atraso. Evite juros!"
                        : "Esta dívida ainda está pendente.";

                const botaoPagar = divida.Status !== "Pago"
                    ? `<a href="/Divida/Pagar/${divida.Id}" class="inline-block mt-2 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm">Pagar agora</a>`
                    : "";

                detailsRow.innerHTML = `
    <td colspan="7">
        <div class="p-4 bg-gray-100 rounded space-y-2">
            <p><strong>Título:</strong> ${divida.Titulo}</p>
            <p><strong>Descrição:</strong> ${divida.Descricao}</p>
            <p><strong>Valor:</strong> R$ ${divida.Valor.toFixed(2)}</p>
            <p><strong>Status:</strong> ${divida.Status}</p>
            <p><strong>Empresa:</strong> ${divida.Empresa?.Nome || '-'}</p>
            <p><strong>Data de Vencimento:</strong> ${divida.DataVencimento || '-'}</p>
            <p><strong>Data de Pagamento:</strong> ${divida.DataPagamento || '-'}</p>
            ${divida.Status !== "Pago" ? `
                <form method="post" action="/Divida/Pagar/${divida.Id}">
                    <button type="submit" class="bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded">
                        Pagar Agora
                    </button>
                </form>
            ` : `<p class="text-green-700 font-semibold">Esta dívida já foi paga.</p>`}
        </div>
    </td>
`;

                detailsRow.classList.remove('hidden');
            }
        }
    </script>
}
